---
title: ìŠ¤í”„ë§ ì„¸ì…˜ Keyê°€ ë‘ ê°œ ìƒì„±ë˜ëŠ” ë¬¸ì œì™€ ì¸ì½”ë”© ëœ ê°’ì˜ ë¹„ë°€
excerpt: ìŠ¤í”„ë§ ì„¸ì…˜ì„ ì ìš©í•˜ë©´ì„œ Keyê°€ ë‘ ê°œ ìƒì„±ë˜ëŠ” ë¬¸ì œì™€, ì¸ì½”ë”© ëœ ê°’ì´ ìƒê¸°ëŠ” ì›ì¸ì„ íŒŒì•…í•˜ê³  í•´ê²°í•˜ëŠ” ê³¼ì •ì„ ì •ë¦¬í•˜ì˜€ìŠµë‹ˆë‹¤.
categories: [project]
tags: [ìŠ¤í”„ë§ì„¸ì…˜, ì¥ë°”êµ¬ë‹ˆ, í•„í„°, ìŠ¤í”„ë§ë¶€íŠ¸, ì½”í‹€ë¦°]
image:
  path: /assets/img/project/covers/ì¥ë°”êµ¬ë‹ˆ_ë””ìì¸íŒ¨í„´_ì»¤ë²„.png
---

Spring Sessionì„ ì´ìš©í•˜ë©´ì„œ ì„¸ì…˜ì´ ë‘ ê°œ ìƒì„±ë˜ëŠ” ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” ê³¼ì •ì„ ì •ë¦¬í•´ë³´ì•˜ìŠµë‹ˆë‹¤. <br>

## ğŸ” Keyê°€ ë‘ ê°œ ìƒì„±ë˜ëŠ” ë¬¸ì œ

ì„¸ì…˜ì„ ì €ì¥í•˜ëŠ” ë¡œì§ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

~~~java
@Component  
class SessionFilter(  
    private val redisSessionRepository: RedisSessionRepository,  
): OncePerRequestFilter() {  
  
    val log = logger()  
  
    override fun doFilterInternal(  
	    request: HttpServletRequest,  
	    response: HttpServletResponse,  
	    filterChain: FilterChain  
	) {  
  
	    val session = getSessionFromCookie(request)          --- 1
	    if (session == null) {  
	        val sessionId = request.getSession(true).id      --- 2
	        myRedisSessionRepository.setSession(sessionId)   --- 3
	    }  
  
	    filterChain.doFilter(request, response)  
	}
}
~~~

1. ì¿ í‚¤ì— ì„¸ì…˜ì— ëŒ€í•œ ì •ë³´ê°€ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.
2. ì„¸ì…˜ì´ ì—†ë‹¤ë©´ ìƒˆë¡œìš´ ì„¸ì…˜ì„ ìƒì„±í•œë‹¤.
3. ìƒˆë¡œ ë°œê¸‰ë°›ì€ ì„¸ì…˜ì„ ë ˆë””ìŠ¤ì— ì €ì¥í•œë‹¤.

![1ë²ˆ.png](/assets/img/project/session/fix/1ë²ˆ.png)

ê²°ê³¼ë¥¼ ë³´ë©´ ì„¸ì…˜ì´ ë‘ ê°œê°€ ì €ì¥ë˜ì—ˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ëŠ” ìœ„ì˜ ì½”ë“œì— ì˜í•´ ì €ì¥ëœ ê²ƒì´ê³  2ë²ˆ ì„¸ì…˜ì€ ì™œ ì €ì¥ëœ ê²ƒì¼ê¹Œìš”?


ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ë””ë²„ê¹… ëª¨ë“œë¡œ ì½”ë“œë¥¼ í•˜ë‚˜ì”© ë”°ë¼ ê°€ ë³´ê² ìŠµë‹ˆë‹¤.

1. getSession()ì„ í˜¸ì¶œí•˜ë©´ HttpServletRequestWrapperì˜ getSessionì´ í˜¸ì¶œëœë‹¤.
~~~java
class HttpServletRequestWrapper {
	@Override  
	public HttpSession getSession(boolean create) {  
	    return this._getHttpServletRequest().getSession(create);  
	}
}
~~~

2. SessionRepositoryFilterê°€ ë™ì‘í•œë‹¤.
~~~java
@Override  
public HttpSessionWrapper getSession(boolean create) {  
	 // 1. Sessionì´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    HttpSessionWrapper currentSession = getCurrentSession();  
    if (currentSession != null) {  
       return currentSession;  
    }  

	 // 2. Sessionì„ ìƒì„±í•˜ê³  ë“±ë¡í•©ë‹ˆë‹¤.
    S session = SessionRepositoryFilter.sessionRepository.createSession();  
    session.setLastAccessedTime(Instant.now());  
    currentSession = new HttpSessionWrapper(session, getServletContext());  
    setCurrentSession(currentSession);  
    return currentSession;  
}
~~~

3. RedisSessionRepositoryê°€ ë™ì‘í•œë‹¤.
~~~java
public RedisSessionRepository {
	@Override  
	public RedisSession createSession() {  
	    MapSession cached = new MapSession();  
	    cached.setMaxInactiveInterval(this.defaultMaxInactiveInterval);  
	    RedisSession session = new RedisSession(cached, true);  
	    session.flushIfRequired();  // 
	    return session;  
	}
}
~~~

ì—¬ê¸°ì„œ flushëª¨ë“œê°€ yesë¼ë©´ ê³§ë°”ë¡œ ìºì‹œì— ì—…ë°ì´íŠ¸ ë˜ê³  noë¼ë©´ ì‘ë‹µì„ ë³´ë‚´ê¸° ì „ì— DispatcherServletì—ì„œ save() ë©”ì„œë“œë¥¼ í˜¸ì¶œí•˜ì—¬ ì €ì¥í•˜ëŠ” ì‘ì—…ì„ ê±°ì¹©ë‹ˆë‹¤.
ì¦‰, ì„¸ì…˜ì„ ìƒˆë¡œ ë°œê¸‰í•˜ë©´ SessionRepositoryFilterê°€ ë™ì‘í•˜ì—¬ Redisì— ì„¸ì…˜ì„ ì €ì¥í•´ì¤ë‹ˆë‹¤.

ë”°ë¼ì„œ `request.getSession(true)`ë¥¼ í˜¸ì¶œí•˜ë©´ ì„¸ì…˜ì„ ìë™ìœ¼ë¡œ ì €ì¥í•´ì£¼ê¸° ë•Œë¬¸ì— `myRedisSessionRepository.setSession(sessionId)` ì½”ë“œëŠ” í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.

## ğŸ” ì¿ í‚¤ì™€ Base64 ì¸ì½”ë”©
ì›¹ ë¸Œë¼ìš°ì €ì—ì„œ í™•ì¸í•´ë³´ë©´ SESSIONì´ ì¸ì½”ë”©ë˜ì–´ì„œ ë“¤ì–´ê°„ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì„¸ì…˜ì´ ë‘ ê°œ ìˆëŠ”ë° ì´ëŠ” [ë‹¤ìŒ ê¸€](#-keyê°€-ë‘-ê°œ-ìƒì„±ë˜ëŠ”-ë¬¸ì œ)ê³¼ ê´€ë ¨ì´ ìˆìŠµë‹ˆë‹¤.)
![2ë²ˆ.png](/assets/img/project/session/fix/2ë²ˆ.png)

configurationì—ì„œ session ìƒì„±ì„ falseë¡œ ë‘ë©´ ëœë‹¤ê³  í•˜ë˜ë° ì €ëŠ” ì˜ ë™ì‘ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (ìŠ¤í”„ë§ì˜ ì„¸ì…˜ ìƒì„± ê¸°ëŠ¥ì„ ëˆë‹¤ëŠ” ì˜ë¯¸ì´ë‹ˆê¹Œ ì•„ë§ˆ ì œëŒ€ë¡œ ë™ì‘í–ˆë‹¤ë©´ ìœ„ì˜ ë¬¸ì œë„ ê°™ì´ í•´ê²°ë˜ì—ˆì„ ê²ƒ ê°™ë„¤ìš”.) <br> 
ë‹¤ìŒ ë§í¬ì—ì„œ íŒíŠ¸ë¥¼ ì–»ì–´ DefaultCookieSerializerë¶€í„° ë””ë²„ê¹… ëª¨ë“œë¡œ í•˜ë‚˜ì”© ì°¾ì•„ë‚˜ê°”ìŠµë‹ˆë‹¤. <br>

[DefaultCookieSerializer - StackOverflow](https://stackoverflow.com/questions/51517246/whats-the-difference-between-cookie-session-and-session-id-in-database-for-spri)


`val sessionId = request.getSession(true).id` ë‹¤ìŒ ì½”ë“œë¥¼ í˜¸ì¶œí•˜ëŠ” ìˆœê°„ RedisSessionRepositoryì—ì„œ ì„¸ì…˜ì„ ìƒì„±í•˜ê³  ì´ë¥¼ í˜„ì¬ ì„¸ì…˜ìœ¼ë¡œ ë„£ì€ ë‹¤ìŒ í—¤ë”ì— ì¶”ê°€í•´ì¤ë‹ˆë‹¤. 
ì¦‰, ì¶”ê°€ì ìœ¼ë¡œ headerì— ë‹´ëŠ” ë¡œì§ì´ í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤. ì‹¤ì œë¡œ ì„¸ì…˜ì´ 2ê°œê°€ ë“¤ì–´ì™”ì§€ë§Œ í•˜ë‚˜ëŠ” base64ë¡œ ì¸ì½”ë”© í•œ ê°’ì…ë‹ˆë‹¤.

ì´ë¥¼ ì¶”ì í•˜ë©´ì„œ ë½‘ì•„ë‚¸ ì¤‘ìš”í•œ ì½”ë“œ ë¦¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤.
1. Sessionì´ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.
~~~java
@Override  
public HttpSessionWrapper getSession(boolean create) {  
    HttpSessionWrapper currentSession = getCurrentSession();  

	// í˜„ì¬ ì„¸ì…˜ì´ ì¡´ì¬í•˜ë©´ return 
    if (currentSession != null) {  
       return currentSession;  
    }  
    
	// ìºì‹œë˜ì–´ ìˆëŠ” ì„¸ì…˜ì´ ìˆëŠ”ì§€ í™•ì¸
    S requestedSession = getRequestedSession();  
    if (requestedSession != null) {  
       if (getAttribute(INVALID_SESSION_ID_ATTR) == null) {  
          requestedSession.setLastAccessedTime(Instant.now());  
          this.requestedSessionIdValid = true;  
          currentSession = new HttpSessionWrapper(requestedSession, getServletContext());  
          currentSession.markNotNew();  
          setCurrentSession(currentSession);  
          return currentSession;  
       }  
    }

	// createì˜ ì†ì„±ì´ fasleë¼ë©´ ì„¸ì…˜ì„ ìƒì„±í•˜ì§€ ì•ŠëŠ”ë‹¤.
	if (!create) {  
	    return null;  
	}

	// create = trueë¼ë©´ ìƒˆë¡œìš´ ì„¸ì…˜ì„ ìƒì„±í•œë‹¤.
	S session = SessionRepositoryFilter.this.sessionRepository.createSession();  
	session.setLastAccessedTime(Instant.now());  
	currentSession = new HttpSessionWrapper(session, getServletContext());  
	setCurrentSession(currentSession);  
	return currentSession;
}
~~~

2. ì§€ì •í•œ ìŠ¤í† ë¦¬ì§€ì—ì„œ Sessionì„ ìƒì„±í•œë‹¤. (flushëª¨ë“œì— ë”°ë¼ ì €ì¥ ì‹œì ì´ ë‹¤ë¥´ë‹¤)
~~~java
@Override  
public RedisSession createSession() {  
    MapSession cached = new MapSession();  
    cached.setMaxInactiveInterval(this.defaultMaxInactiveInterval);  
    RedisSession session = new RedisSession(cached, true);  
    session.flushIfRequired();  
    return session;  
}
~~~

3. ì´í›„ Response ë³´ë‚´ê¸° ì „ì— ì„¸ì…˜ì„ Base64ë¡œ ì¸ì½”ë”©í•˜ì—¬ headerì— ì €ì¥í•œë‹¤.
~~~java
@Override  
public void setSessionId(HttpServletRequest request, HttpServletResponse response, String sessionId) {  
    if (sessionId.equals(request.getAttribute(WRITTEN_SESSION_ID_ATTR))) {  
       return;  
    }  
    request.setAttribute(WRITTEN_SESSION_ID_ATTR, sessionId);  
    this.cookieSerializer.writeCookieValue(new CookieValue(request, response, sessionId));  
}
~~~
~~~java
@Override  
public void writeCookieValue(CookieValue cookieValue) {  
    String value = getValue(cookieValue);   // getValue()ì—ì„œ ì¸ì½”ë”©í•¨.
	...
    response.addHeader("Set-Cookie", sb.toString());  // í—¤ë”ì— ì €ì¥
}
~~~

### ê²°ë¡ 
1. ìŠ¤í”„ë§ ì„¸ì…˜ì„ ì ìš©í•˜ë©´ sessionì´ ìƒì„±ë˜ëŠ” ì‹œì ì— ë°ì´í„°ë¥¼ ì €ì¥í•´ì¤€ë‹¤.
2. ì„¸ì…˜ì„ ì¿ í‚¤ë¡œ ë°˜í™˜í•  ë•ŒëŠ” Base64ë¡œ ì¸ì½”ë”©í•˜ë©´ ë°˜í™˜í•œë‹¤.
